# Next.js Hydrationエラー 調査レポート

## 1. 問題の概要

- **症状**: サイトのトップページを含む複数のページで、Next.jsのHydrationエラー（`Error: Hydration failed because the initial UI does not match what was rendered on the server.`）が継続的に発生。
- **影響**: ページの表示はされるものの、コンソールにエラーが表示され、インタラクティブな機能が不安定になる可能性がある状態だった。

## 2. 調査プロセス

1.  **初期調査**: ログファイル (`HYDRATION_ERROR_DEBUG_LOG.md`) を元に、これまでの試行（コンポーネントの簡素化、ライブラリの削除、Next.jsのバージョン変更など）を確認。コードレベルの単純な修正では解決しない、根深い問題であると判断。

2.  **妨害要因の特定（CSPエラー）**: `/test` ページでの検証中、Hydrationエラーではなく `Content Security Policy (CSP)` エラーがコンソールに出力されていることを確認。シークレットモードでアクセスするとエラーが消えたことから、**ブラウザの拡張機能が原因**であると特定。拡張機能を無効化し、この問題を解決。

3.  **原因箇所の切り分け（コンポーネント）**: CSPエラー解決後も、本命のHydrationエラーが再発。ページのコンポーネント (`HomeJa.tsx`) の中身をセクションごとにコメントアウトしていく手法で、エラー原因の特定を試みた。

4.  **原因箇所の切り分け（レイアウト）**: `HomeJa.tsx` の中身をほぼ空にしてもエラーが解消されなかったため、原因はコンポーネントの外側、つまりレイアウトファイルにあると判断。

5.  **根本原因の特定**: `src/app/[lang]/layout.tsx` を調査・修正したがエラーは解消せず。最終的に、そのさらに親である **`src/app/layout.tsx`（ルートレイアウト）** との関係性を調査した結果、問題の核心に到達した。

## 3. 根本原因

**`<html>`および`<body>`タグの二重ネスト**が根本的な原因でした。

Next.js App Routerの構造は以下のようになっていました。

- **`src/app/layout.tsx` (ルートレイアウト)**: ここで `<html>` と `<body>` タグが定義されていました。
- **`src/app/[lang]/layout.tsx` (言語別レイアウト)**: ここでも**誤って** `<html>` と `<body>` タグが定義されていました。

Next.jsは、まずルートレイアウトをレンダリングし、その `{children}` の部分に言語別レイアウトを挿入します。その結果、以下のような不正なHTML構造が生成されていました。

```html
{/* src/app/layout.tsx から */}
<html lang="ja">
  <body>
    {/* ここに [lang]/layout.tsx の中身が挿入される */}
    <html lang="ja">  <-- 不正なネスト！
      <body>        <-- 不正なネスト！
        {/* ページコンポーネント */}
      </body>
    </html>
  </body>
</html>
```

サーバーはこのようなHTMLを生成しますが、ブラウザはこれを解釈する際に自動的に修正を試みます。この**「サーバーが生成したHTML」と「ブラウザが解釈・修正したHTML」の構造的な不一致**が、Hydrationエラーを引き起こしていました。

## 4. 実施した解決策

- `src/app/[lang]/layout.tsx` から、ネストの原因となっていた `<html>` と `<body>` タグを完全に削除しました。
- これにより、このファイルはメタデータ (`generateMetadata`) を提供しつつ、ページコンテンツ (`{children}`) をそのまま通過させるだけのシンプルなコンポーネントになりました。
- 結果として、サイト全体のHTML構造が正常化され、`<html>`と`<body>`はルートレイアウト (`src/app/layout.tsx`) によって一度だけレンダリングされるようになり、Hydrationエラーは解消されました。

## 5. 今後のための予防策

同様の問題を再発させないために、以下のルールを徹底します。

1.  **【最重要】レイアウトのネスト構造を正しく理解する**
    - Next.js App Routerでは、**ルートレイアウト (`/app/layout.tsx`) のみが `<html>` と `<body>` タグを持つべき**です。
    - サブディレクトリのレイアウト (`/app/foo/layout.tsx`など) は、これらのタグを含んではいけません。これらは親レイアウトの`<body>`内に挿入される、ただのReactコンポーネントです。

2.  **原因不明のエラーは環境を疑う**
    - 今回のように、コードを修正しても解決しないエラーに直面した場合、**まずはブラウザのシークレットモードで試す**ことを徹底します。これにより、拡張機能や特殊なキャッシュが原因かどうかを迅速に切り分けることができます。

3.  **『二分探索』的なデバッグ手法を徹底する**
    - Hydrationエラーのように原因箇所が不明な場合、ページやコンポーネントの要素を**大きな単位で大胆にコメントアウト**していく手法が極めて有効です。これにより、問題が存在する範囲を効率的に半分に絞り込んでいくことができます。
